#!/bin/sh

set -e
MODE="prod"

while getopts ":m:" arg; do
  case $opt in
    m) if [ "$OPTARG" = "dev" ] || [ "$OPTARG" = "prod" ]; then
        MODE=$OPTARG
      else
        echo "ERROR: Invalid mode: $OPTARG"
        exit 1
      fi
      ;;
    ?) echo "ERROR: Invalid option: -${OPTARG}."
      exit 2
      ;;
    :) echo "ERROR: Must supply an argument to -$OPTARG."
      exit 1
      ;;
  esac
done

printf "Starting in $MODE mode...\r"
if [ "${PWD##*/}" = "bin" ]; then
  cd ..
fi

if [ "$MODE" = "dev" ]; then
  printf "Building dependencies...\r"
  mix local.hex --if-missing --force > /dev/null
  mix local.rebar --if-missing --force > /dev/null
  mix deps.get > /dev/null
  printf "\r"
  source ./.env && MIX_ENV=$MODE mix run --no-halt
else
  exec "/app/hexerei/${MODE}/rel/${MODE}/bin/prod" "start"
fi

exit 0
